<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elite QR WebRTC Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { margin: 0; background: #0b141a; color: #fff; font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; }
        header { padding: 15px; background: #202c33; text-align: center; font-weight: bold; border-bottom: 1px solid #333; }
        .container { flex: 1; display: flex; flex-direction: column; padding: 10px; gap: 10px; overflow: hidden; }
        .video-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        video { width: 100%; aspect-ratio: 4/3; background: #000; border-radius: 8px; border: 1px solid #444; }
        .controls { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; padding: 10px; }
        button { background: #00a884; color: #fff; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:disabled { background: #333; cursor: not-allowed; }
        #qrBox { background: white; padding: 10px; border-radius: 8px; display: none; align-self: center; margin-top: 10px; }
        #qrScanner { width: 300px; margin: auto; display: none; }
        .chat-area { flex: 1; display: flex; flex-direction: column; background: #0b141a; border-radius: 8px; overflow: hidden; }
        #messages { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; }
        .msg { padding: 8px 12px; border-radius: 8px; max-width: 80%; word-break: break-word; }
        .sent { background: #005c4b; align-self: flex-end; }
        .received { background: #202c33; align-self: flex-start; }
        .input-row { display: flex; gap: 5px; padding: 10px; background: #202c33; }
        input { flex: 1; background: #2a3942; border: none; color: #fff; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>

<header>WebRTC QR CHAT (SERVERLESS)</header>

<div class="container">
    <div class="video-grid">
        <video id="localVideo" autoplay muted playsinline></video>
        <video id="remoteVideo" autoplay playsinline></video>
    </div>

    <div class="controls">
        <button id="startBtn">1. Start Media</button>
        <button id="offerBtn" disabled>2. Create Offer (A)</button>
        <button id="scanBtn">Scan QR (A or B)</button>
    </div>

    <div id="qrBox"></div>
    <div id="qrScanner"></div>

    <div class="chat-area">
        <div id="messages"></div>
        <div class="input-row">
            <input id="msgInput" placeholder="Type a message..." disabled>
            <button id="sendBtn" disabled>Send</button>
        </div>
    </div>
</div>

<script>
    let pc, channel, localStream;
    const iceConfig = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

    // Initialize UI Elements
    const elements = {
        startBtn: document.getElementById('startBtn'),
        offerBtn: document.getElementById('offerBtn'),
        scanBtn: document.getElementById('scanBtn'),
        sendBtn: document.getElementById('sendBtn'),
        msgInput: document.getElementById('msgInput'),
        qrBox: document.getElementById('qrBox'),
        qrScanner: document.getElementById('qrScanner')
    };

    function initPeer() {
        if (pc) return;
        pc = new RTCPeerConnection(iceConfig);

        pc.onicecandidate = e => {
            if (!e.candidate) {
                console.log("ICE Gathering Complete");
                elements.qrBox.style.display = "block";
                generateQR(JSON.stringify(pc.localDescription));
            }
        };

        pc.ontrack = e => {
            document.getElementById("remoteVideo").srcObject = e.streams[0];
        };

        pc.ondatachannel = e => {
            channel = e.channel;
            setupDataChannel();
        };
    }

    function setupDataChannel() {
        channel.onopen = () => {
            elements.msgInput.disabled = false;
            elements.sendBtn.disabled = false;
            addMessage("System: Connected!", "received");
        };
        channel.onmessage = e => addMessage(e.data, "received");
    }

    elements.startBtn.onclick = async () => {
        try {
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById("localVideo").srcObject = localStream;
            initPeer();
            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
            elements.offerBtn.disabled = false;
            elements.startBtn.disabled = true;
        } catch (err) { alert("Camera access denied."); }
    };

    elements.offerBtn.onclick = async () => {
        initPeer();
        channel = pc.createDataChannel("chat");
        setupDataChannel();
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
    };

    elements.scanBtn.onclick = () => {
        elements.qrScanner.style.display = "block";
        const scanner = new Html5Qrcode("qrScanner");
        scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, async (text) => {
            await scanner.stop();
            elements.qrScanner.style.display = "none";
            handleScannedData(text);
        }).catch(err => console.error(err));
    };

    async function handleScannedData(qrText) {
        const data = JSON.parse(qrText);
        initPeer();
        if (data.type === "offer") {
            await pc.setRemoteDescription(data);
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
        } else if (data.type === "answer") {
            await pc.setRemoteDescription(data);
        }
    }

    function generateQR(text) {
        elements.qrBox.innerHTML = "";
        new QRCode(elements.qrBox, { text: text, width: 250, height: 250 });
    }

    elements.sendBtn.onclick = () => {
        const val = elements.msgInput.value;
        if (val.trim() && channel.readyState === "open") {
            channel.send(val);
            addMessage(val, "sent");
            elements.msgInput.value = "";
        }
    };

    function addMessage(text, type) {
        const div = document.createElement("div");
        div.className = `msg ${type}`;
        div.textContent = text;
        const msgContainer = document.getElementById("messages");
        msgContainer.appendChild(div);
        msgContainer.scrollTop = msgContainer.scrollHeight;
    }
</script>
</body>
</html>
CPWMSDB01Dec25